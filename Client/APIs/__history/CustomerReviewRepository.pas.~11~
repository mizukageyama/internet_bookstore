unit CustomerReviewRepository;

interface

uses
  CustomerReviewRepositoryIntf, CustomerReview, MVCFramework.RESTClient.Intf,
  MVCFramework.RESTClient, MVCFramework.DataSet.Utils,
  System.Generics.Collections, JSON, System.SysUtils;

type
  TCustomerReviewApi = class(TInterfacedObject,
    ICustomerReviewApi)
  private
    FRESTClient: IMVCRESTClient;
    const
      ENDPOINT = '/api/reviews';
  protected
    function CreateReview(const RequestBody: string): IMVCRESTResponse;
    function GetReviewsByBookId(const BookId: Integer): IMVCRESTResponse;
    function GetReviewById(const ReviewId: Integer): IMVCRESTResponse;
    function UpdateReview(const RequestBody: string): IMVCRESTResponse;
    function DeleteReview(const ReviewId: Integer): IMVCRESTResponse;
  public
    constructor Create;
    destructor OnDestroy;
  end;

implementation

uses
  CustomerSession;

{ TCustomerReviewRepository }

constructor TCustomerReviewApi.Create;
begin
  FRESTClient := TMVCRESTClient.New.BaseURL('localhost', 8080);
end;

function TCustomerReviewApi.CreateReview(
  const RequestBody: string): IMVCRESTResponse;
var
  Response: IMVCRESTResponse;
  CustomerSession: TCustomerSession;
begin
  CustomerSession := TCustomerSession.Instance;
  FRESTClient.SetBearerAuthorization(CustomerSession.GetToken);
  FRESTClient.AddBody(RequestBody, 'application/json');
  Response := FRESTClient.POST(ENDPOINT);
  Result := Response;
end;

function TCustomerReviewApi.DeleteReview(
  const ReviewId: Integer): IMVCRESTResponse;
var
  Response: IMVCRESTResponse;
begin
  FRESTClient.SetBearerAuthorization('token');
  Response := FRESTClient.DELETE(ENDPOINT + '/'+ ReviewId.toString);
  Result := Response;
end;

function TCustomerReviewApi.GetReviewById(
  const ReviewId: Integer): IMVCRESTResponse;
var
  Response: IMVCRESTResponse;
begin
  Response := FRESTClient.GET(ENDPOINT + '/'+ ReviewId.toString);
  Result := Response;
end;

function TCustomerReviewApi.GetReviewsByBookId(
  const BookId: Integer): IMVCRESTResponse;
var
  Response: IMVCRESTResponse;
begin
  Response := FRESTClient.GET(ENDPOINT + '/'+ BookId.toString);
  Result := Response;
end;

destructor TCustomerReviewApi.OnDestroy;
begin
  FRESTClient := nil;
end;

function TCustomerReviewApi.UpdateReview(
  const RequestBody: string): IMVCRESTResponse;
var
  Response: IMVCRESTResponse;
begin
  FRESTClient.SetBearerAuthorization('token');
  FRESTClient.AddBody(RequestBody, 'application/json');
  Response := FRESTClient.PUT(ENDPOINT);
  Result := Response;
end;

end.
