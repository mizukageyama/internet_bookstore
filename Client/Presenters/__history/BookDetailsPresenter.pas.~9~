unit BookDetailsPresenter;

interface

uses
  MainPresenterIntf, BookServiceClientIntf, MainFrmIntf, System.SysUtils,
  Vcl.Dialogs, MVCFramework.DataSet.Utils, MVCFramework.Serializer.Commons,
  BookstoreDM, BookDTO, BookDetailsFrm, System.Variants, BookDetailsFrmIntf,
  System.Classes, Vcl.Graphics, Vcl.Controls, Vcl.Forms,
  CustomerReviewServiceClientIntf, BookDetailsPresenterIntf;

type
  TBookDetailsPresenter = class(TInterfacedObject, IBookDetailsPresenter)
  private
    FBookDetailsView: IBookDetailsForm;
    FBookDetailsService: ICustomerReviewServiceClient;
  protected
    procedure LoadReviews(const BookId: Integer);
    procedure WriteReview;
    procedure CheckCustomerSession;
    procedure PopulateReviewsTable(JSONData: string);
  public
    constructor Create(ABookDetailsView: IBookDetailsForm;
      ABookDetailsService: ICustomerReviewServiceClient);
  end;

implementation

{ TBookDetailsPresenter }

constructor TBookDetailsPresenter.Create(ABookDetailsView: IBookDetailsForm;
  ABookDetailsService: ICustomerReviewServiceClient);
begin
  FBookDetailsView := ABookDetailsView;
  FBookDetailsService := ABookDetailsService;
  FBookDetailsView.SetPresenter(Self);
end;

procedure TBookDetailsPresenter.LoadReviews(const BookId: Integer);
begin
  var ResponseContent := FBookDetailsService.GetCustomerReviewsByBookId(BookId);
  PopulateReviewsTable(ResponseContent);
end;

procedure TBookDetailsPresenter.PopulateReviewsTable(JSONData: string);
begin
  var BookstoreDM := BookstoreDataModule;
  BookstoreDM.fdmemBook.Close;
  BookstoreDM.fdmemBook.Open;
  BookstoreDM.fdmemBook.LoadJSONArrayFromJSONObjectProperty('data', JSONData,
    TMVCNameCase.ncPascalCase);
  BookstoreDM.fdmemBook.First;
end;

procedure TMainPresenter.ShowBookDetails;
begin
  FMainView.HideForm;
  var BookstoreDM := BookstoreDataModule;

  var BookId := (BookstoreDM.fdmemBookId.Value);
  var BookTitle := (BookstoreDM.fdmemBookTitle.Value);
  var BookSynopsis := (BookstoreDM.fdmemBookSynopsis.Value);

  var SelectedBook := TBook.Create(BookId, BookTitle, BookSynopsis);
  var BookDetailsForm := TBookDetailsForm.Create(SelectedBook, FMainView.Self);
  BookDetailsForm.Show;
end;

end.

